<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AUDâ€“USD FX Dashboard</title>
  <meta name="description" content="AUD/USD exchange rate dashboard with intraday (15m) and daily 1W/1M/1Y ranges. Ready for GitHub Pages." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ’±</text></svg>">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .card { border-radius: 1rem; border: 1px solid rgb(226 232 240 / .6); background: rgba(255,255,255,.8); backdrop-filter: saturate(1.1) blur(2px); }
    .heartbeat { display:inline-block; width:10px; height:10px; border-radius:50%; background:#10b981; margin-right:6px; animation:pulse 1.5s infinite; }
    @keyframes pulse { 0%{transform:scale(1);opacity:1;} 50%{transform:scale(1.5);opacity:.5;} 100%{transform:scale(1);opacity:1;} }
    .heartbeat.stale { background:#dc2626; animation:none; }
    .btn { padding:.5rem .75rem; border-radius:.75rem; border:1px solid rgb(226 232 240 / .6); }
    .btn-active { background:#2563eb; color:white; border-color:#2563eb; }
    .btn-inactive { background:rgba(255,255,255,.7); }
    .kpi { font-size:2rem; font-weight:600; }
    .note-red { color:#dc2626; }
    .grid-compact { display:grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap: .75rem; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 text-slate-900 dark:text-slate-100">
  <main class="max-w-6xl mx-auto p-5 md:p-8 pb-16" id="appRoot">
    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">AUDâ€“USD FX Dashboard</h1>
        <span class="px-2 py-1 text-xs rounded-md bg-slate-200/70 dark:bg-white/10" id="clock">â€”</span>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm" for="pair">Pair</label>
        <select id="pair" class="btn">
          <option value="AUD_USD" selected>AUD â†’ USD</option>
          <option value="USD_AUD">USD â†’ AUD</option>
        </select>
        <button id="fullscreenBtn" class="btn btn-inactive">â›¶ Fullscreen</button>
      </div>
    </header>

    <!-- KPIs -->
    <section class="card p-5 mb-6 grid-compact">
      <div>
        <div class="text-xs uppercase tracking-wide text-slate-500">Spot</div>
        <div class="kpi" id="spot">â€”</div>
        <div class="text-xs text-slate-500" id="asof">as of â€”</div>
      </div>
      <div>
        <div class="text-xs uppercase tracking-wide text-slate-500">Change (<span id="rangeLabel">session</span>)</div>
        <div class="flex items-baseline gap-3">
          <span id="delta" class="text-xl font-semibold">â€”</span>
          <span id="pct" class="text-sm">â€”</span>
        </div>
      </div>
      <div>
        <div class="text-xs uppercase tracking-wide text-slate-500">OHLC (<span id="rangeLabel2">session</span>)</div>
        <div class="text-sm" id="ohlc">O â€”  H â€”  L â€”  C â€”</div>
      </div>
      <div class="flex items-center justify-end gap-3 text-xs text-slate-500">
        <div id="sourceNote">Source: Yahoo Finance (15m) via GitHub Actions</div>
        <div class="flex items-center gap-2"><span class="heartbeat" id="heartbeat"></span><span id="lastUpdated">Last updated â€”</span></div>
      </div>
      <div class="md:col-span-4 flex items-end justify-end gap-2 pt-2">
        <button class="btn btn-active" data-range="1D">1D</button>
        <button class="btn btn-inactive" data-range="1W">1W</button>
        <button class="btn btn-inactive" data-range="1M">1M</button>
        <button class="btn btn-inactive" data-range="1Y">1Y</button>
      </div>
    </section>

    <!-- Chart -->
    <section class="card p-4 mb-6">
      <div class="flex items-center justify-between px-1 pb-2">
        <h2 class="text-sm md:text-base font-semibold" id="chartTitle">AUD/USD â€” 1D (15m)</h2>
      </div>
      <canvas id="chart" height="200"></canvas>
      <div class="text-xs mt-2 text-slate-500" id="statusMsg"></div>
    </section>
  </main>

  <script>
    // ===== Config =====
    const SHEET_CSV_URL = ""; // optional fallback
    const DAILY_JSON_AUD = "data/audusd_daily.json";
    const DAILY_JSON_USD = "data/usdaud_daily.json";

    // ===== Utilities =====
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const tz = "Australia/Sydney";
    function tickClock() {
      const el = $("#clock");
      if (!el) return;
      el.textContent = new Intl.DateTimeFormat(undefined, { timeZone: tz, hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false }).format(new Date()) + " AEST/AEDT";
    }
    setInterval(tickClock, 1000); tickClock();

    function parseCSV(text) {
      return text.trim().split(/\r?\n/).map(line => line.split(/\s*,\s*/));
    }
    function sliceForRange(candles, range) {
      const now = Date.now();
      const day = 24*60*60*1000;
      let lookback = 1*day;
      if (range === "1W") lookback = 8*day;
      if (range === "1M") lookback = 35*day;
      if (range === "1Y") lookback = 370*day;
      return candles.filter(c => (now - c.ts) <= lookback);
    }

    // ===== Data sources =====
    async function fetchJsonIntraday(pair) {
      const path = pair === "USD_AUD" ? "data/usdaud_15m.json" : "data/audusd_15m.json";
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error("Intraday JSON not available: " + path);
      return res.json();
    }
    async function fetchJsonDaily(pair) {
      const path = pair === "USD_AUD" ? DAILY_JSON_USD : DAILY_JSON_AUD;
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error("Daily JSON not available: " + path);
      return res.json();
    }
    async function fetchSheet15m() {
      if (!SHEET_CSV_URL) throw new Error("SHEET_CSV_URL not set");
      const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Sheet CSV not reachable: " + res.status);
      const rows = parseCSV(await res.text());
      const dataRows = (rows[0] && /date|time/i.test(rows[0][0])) ? rows.slice(1) : rows;
      const candles = [];
      for (const r of dataRows) {
        if (!r || r.length < 2) continue;
        const ts = Date.parse(r[0].replace(" ", "T"));
        const close = parseFloat(r[1]);
        if (!isNaN(ts) && isFinite(close)) {
          candles.push({ ts, open: close, high: close, low: close, close, volume: 0 });
        }
      }
      candles.sort((a,b)=>a.ts-b.ts);
      return {
        symbol: "AUDUSD (sheet)",
        interval: "15m",
        updated: candles.length ? candles[candles.length-1].ts : Date.now(),
        tz: "UTC",
        meta: {
          records: candles.length,
          first_ts: candles[0]?.ts || null,
          last_ts: candles[candles.length-1]?.ts || null,
          session_ohlc: (()=>{
            const closes = candles.map(c=>c.close);
            if (!closes.length) return {open:null,high:null,low:null,close:null};
            return { open: closes[0], high: Math.max(...closes), low: Math.min(...closes), close: closes[closes.length-1] };
          })(),
          volume_sum: 0
        },
        candles
      };
    }
    async function fetchDailyFallback() {
      const end = new Date();
      const url = `https://api.frankfurter.app/${end.toISOString().slice(0,10-0-0)}..${end.toISOString().slice(0,10)}?base=AUD&symbols=USD`;
      const res = await fetch(url, { cache: "no-store" });
      const data = await res.json();
      const entries = Object.entries(data.rates).sort((a,b)=>a[0].localeCompare(b[0]));
      return {
        symbol: "AUDUSD (ECB daily)",
        interval: "1d",
        updated: entries.length ? Date.parse(entries[entries.length-1][0]) : Date.now(),
        tz: "UTC",
        meta: { records: entries.length, first_ts: entries[0] ? Date.parse(entries[0][0]) : null, last_ts: entries.length ? Date.parse(entries[entries.length-1][0]) : null, session_ohlc: {}, volume_sum: 0 },
        candles: entries.map(([date, obj])=>({ ts: Date.parse(date), open: obj.USD, high: obj.USD, low: obj.USD, close: obj.USD, volume: 0 }))
      };
    }

    // ===== Chart =====
    const ctx = document.getElementById("chart").getContext("2d");
    let chart;
    function renderChart(labels, data, isUp) {
      const color = isUp ? "rgb(16,185,129)" : "rgb(220,38,38)";
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ data, borderColor: color, pointRadius: 1.5, borderWidth: 2.5, tension: .2, fill: false }] },
        options: { plugins:{ legend:{ display:false } }, interaction:{ intersect:false, mode:"index" }, scales:{ x:{ ticks:{ maxTicksLimit:12 } }, y:{ beginAtZero:false } } }
      });
    }

    // ===== UI =====
    const sourceNote = document.getElementById("sourceNote");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const heartbeat = document.getElementById("heartbeat");
    const statusMsg = document.getElementById("statusMsg");
    const pairSel = document.getElementById("pair");
    const rangeButtons = $$("button[data-range]");
    let state = { range: "1D" };

    function setActiveRangeButton(range){
      rangeButtons.forEach(btn => {
        const active = btn.dataset.range === range;
        btn.classList.toggle("btn-active", active);
        btn.classList.toggle("btn-inactive", !active);
      });
      $("#rangeLabel").textContent = range === "1D" ? "session" : range;
      $("#rangeLabel2").textContent = range === "1D" ? "session" : range;
    }

    async function refresh() {
      statusMsg.textContent = "";
      const pair = pairSel.value;
      const range = state.range;
      let payload = null;
      let source = "";
      const freshnessMinutes = range === "1D" ? 15 : 36 * 60; // 15m for intraday; 36h for daily ranges

      try {
        if (range === "1D") {
          try {
            payload = await fetchJsonIntraday(pair);
            source = "Source: Yahoo Finance (15m) via GitHub Actions";
          } catch (e1) {
            payload = await fetchSheet15m();
            if (pair === "USD_AUD" && payload?.candles?.length) {
              payload.candles = payload.candles.map(c=>{
                const inv = (v)=> (v ? 1/v : v);
                return { ...c, open: inv(c.open), high: inv(c.low), low: inv(c.high), close: inv(c.close) };
              });
            }
            source = "Source: Google Sheets â†’ GOOGLEFINANCE (15m)";
          }
        } else {
          payload = await fetchJsonDaily(pair);
          source = "Source: Yahoo Finance (1d) via GitHub Actions";
          // slice to requested window
          payload.candles = sliceForRange(payload.candles, range);
          // recompute session ohlc for the sliced window
          const closes = payload.candles.map(c=>c.close);
          if (closes.length) {
            payload.meta.session_ohlc = { open: closes[0], high: Math.max(...closes), low: Math.min(...closes), close: closes[closes.length-1] };
            payload.meta.first_ts = payload.candles[0].ts;
            payload.meta.last_ts = payload.candles[payload.candles.length-1].ts;
          }
        }
      } catch (e) {
        // Final fallback
        payload = await fetchDailyFallback();
        source = "Source: frankfurter.app (ECB daily) â€” intraday/daily JSON unavailable";
        statusMsg.innerHTML = '<span class="note-red">Feed unavailable</span> â€” showing ECB daily.';
      }

      if (!payload || !payload.candles || payload.candles.length < 2) {
        statusMsg.textContent = "No data available."; return;
      }

      const lastTs = payload.meta?.last_ts ?? payload.updated ?? payload.candles[payload.candles.length-1].ts;
      const minsAgo = Math.floor((Date.now() - lastTs) / 60000);
      const stale = minsAgo > freshnessMinutes;
      lastUpdatedEl.textContent = `Last updated ${new Date(lastTs).toLocaleString([], { hour:'2-digit', minute:'2-digit' })} (${minsAgo}m ago)`;
      heartbeat.classList.toggle("stale", stale);
      sourceNote.textContent = source;

      const ohlc = payload.meta?.session_ohlc || {};
      const first = ohlc.open, last = ohlc.close;
      const delta = (last - first);
      const pct = (delta / first) * 100;
      const isUp = delta >= 0;
      $("#spot").textContent = Number(last).toFixed(5);
      $("#asof").textContent = `as of ${new Date(lastTs).toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' })}`;
      $("#delta").textContent = `${isUp ? 'â–²' : 'â–¼'} ${Math.abs(delta).toFixed(5)}`;
      $("#pct").textContent = `(${isUp ? '+' : 'âˆ’'}${Math.abs(pct).toFixed(2)}%)`;
      $("#delta").classList.toggle("text-emerald-600", isUp);
      $("#delta").classList.toggle("text-red-600", !isUp);
      $("#pct").classList.toggle("text-emerald-600", isUp);
      $("#pct").classList.toggle("text-red-600", !isUp);
      $("#ohlc").textContent = `O ${Number(ohlc.open).toFixed(5)}  H ${Number(ohlc.high).toFixed(5)}  L ${Number(ohlc.low).toFixed(5)}  C ${Number(ohlc.close).toFixed(5)}`;

      const labels = payload.candles.map(c => {
        return range === "1D"
          ? new Date(c.ts).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })
          : new Date(c.ts).toLocaleDateString([], { month:'short', day:'2-digit' });
      });
      const closes = payload.candles.map(c => c.close);
      renderChart(labels, closes, isUp);

      const titlePair = pair === "USD_AUD" ? "USD/AUD" : "AUD/USD";
      $("#chartTitle").textContent = `${titlePair} â€” ${range}${range==='1D'?' (15m)':''}`;
    }

    // Events
    $("#fullscreenBtn").addEventListener("click", async ()=>{
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    });
    $("#pair").addEventListener("change", refresh);
    $$("button[data-range]").forEach(btn => btn.addEventListener("click", () => {
      state.range = btn.dataset.range;
      setActiveRangeButton(state.range);
      refresh();
    }));

    // Run
    setActiveRangeButton(state.range);
    refresh();
    setInterval(refresh, 5 * 60 * 1000);
  </script>
</body>
</html>
