<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AUDâ€“USD FX Dashboard</title>
  <meta name="description" content="AUD/USD dashboard with intraday, daily ranges, indicators, and forecast overlay.">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ’±</text></svg>">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .card { border-radius: 1rem; border: 1px solid rgb(226 232 240 / .6); background: rgba(255,255,255,.8); backdrop-filter: saturate(1.1) blur(2px); }
    .heartbeat { display:inline-block; width:10px; height:10px; border-radius:50%; background:#10b981; margin-right:6px; animation:pulse 1.5s infinite; }
    @keyframes pulse { 0%{transform:scale(1);opacity:1;} 50%{transform:scale(1.5);opacity:.5;} 100%{transform:scale(1);opacity:1;} }
    .heartbeat.stale { background:#dc2626; animation:none; }
    .btn { padding:.5rem .75rem; border-radius:.75rem; border:1px solid rgb(226 232 240 / .6); }
    .btn-active { background:#2563eb; color:white; border-color:#2563eb; }
    .btn-inactive { background:rgba(255,255,255,.7); }
    .kpi { font-size:2rem; font-weight:600; }
    .note-red { color:#dc2626; }
    .grid-compact { display:grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap: .75rem; }
    .ind-grid { display:grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap: .75rem; }
    .muted { color: rgb(100 116 139); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 text-slate-900 dark:text-slate-100">
  <main class="max-w-6xl mx-auto p-5 md:p-8 pb-16" id="appRoot">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">AUDâ€“USD FX Dashboard</h1>
        <span class="px-2 py-1 text-xs rounded-md bg-slate-200/70 dark:bg-white/10" id="clock">â€”</span>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm" for="pair">Pair</label>
        <select id="pair" class="btn">
          <option value="AUD_USD" selected>AUD â†’ USD</option>
          <option value="USD_AUD">USD â†’ AUD</option>
        </select>
        <button id="fullscreenBtn" class="btn btn-inactive">â›¶ Fullscreen</button>
      </div>
    </header>

    <section class="card p-5 mb-6 grid-compact">
      <div>
        <div class="text-xs uppercase tracking-wide muted">Spot</div>
        <div class="kpi" id="spot">â€”</div>
        <div class="text-xs muted" id="asof">as of â€”</div>
      </div>
      <div>
        <div class="text-xs uppercase tracking-wide muted">Change (<span id="rangeLabel">session</span>)</div>
        <div class="flex items-baseline gap-3">
          <span id="delta" class="text-xl font-semibold">â€”</span>
          <span id="pct" class="text-sm">â€”</span>
        </div>
      </div>
      <div>
        <div class="text-xs uppercase tracking-wide muted">OHLC (<span id="rangeLabel2">session</span>)</div>
        <div class="text-sm" id="ohlc">O â€”  H â€”  L â€”  C â€”</div>
      </div>
      <div class="flex items-center justify-end gap-3 text-xs muted">
        <div id="sourceNote">Source: Yahoo Finance (15m) via GitHub Actions</div>
        <div class="flex items-center gap-2"><span class="heartbeat" id="heartbeat"></span><span id="lastUpdated">Last updated â€”</span></div>
      </div>
      <div class="md:col-span-4 flex items-end justify-end gap-2 pt-2">
        <button class="btn btn-active" data-range="1D">1D</button>
        <button class="btn btn-inactive" data-range="1W">1W</button>
        <button class="btn btn-inactive" data-range="1M">1M</button>
        <button class="btn btn-inactive" data-range="1Y">1Y</button>
      </div>
    </section>

    <section class="card p-4 mb-6">
      <div class="flex items-center justify-between px-1 pb-2">
        <h2 class="text-sm md:text-base font-semibold" id="chartTitle">AUD/USD â€” 1D (15m)</h2>
      </div>
      <canvas id="chart" height="220"></canvas>
      <div class="text-xs mt-2 muted" id="statusMsg"></div>
    </section>

    <section class="card p-4">
      <h3 class="text-sm md:text-base font-semibold mb-2">Market Indicators</h3>
      <div class="ind-grid text-sm">
        <div><div class="muted text-xs">20D MA vs Close</div><div id="ma20">â€”</div></div>
        <div><div class="muted text-xs">10D Volatility (Ïƒ)</div><div id="vol10">â€”</div></div>
        <div><div class="muted text-xs">Slope (14D)</div><div id="slope14">â€”</div></div>
        <div><div class="muted text-xs">ATR (14)</div><div id="atr14">â€”</div></div>
      </div>
    </section>
  </main>

  <script>
    const SHEET_CSV_URL = "";
    const DAILY_JSON_AUD = "data/audusd_daily.json";
    const DAILY_JSON_USD = "data/usdaud_daily.json";
    const FCAST_JSON_AUD = "data/audusd_forecast.json";
    const FCAST_JSON_USD = "data/usdaud_forecast.json";

    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const tz = "Australia/Sydney";
    function tickClock() {
      const el = $("#clock");
      if (!el) return;
      el.textContent = new Intl.DateTimeFormat(undefined, { timeZone: tz, hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false }).format(new Date()) + " AEST/AEDT";
    }
    setInterval(tickClock, 1000); tickClock();

    function parseCSV(text) { return text.trim().split(/\r?\n/).map(line => line.split(/\s*,\s*/)); }
    function sliceForRange(candles, range) {
      const now = Date.now(), day = 86400000;
      const look = range==="1W"?8*day:range==="1M"?35*day:range==="1Y"?370*day:1*day;
      return candles.filter(c => (now - c.ts) <= look);
    }
    function mean(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }
    function stddev(arr){ const m=mean(arr); return Math.sqrt(mean(arr.map(x=>(x-m)**2))); }

    async function fetchJsonIntraday(pair) {
      const path = pair === "USD_AUD" ? "data/usdaud_15m.json" : "data/audusd_15m.json";
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error("Intraday JSON not available: " + path);
      return res.json();
    }
    async function fetchJsonDaily(pair) {
      const path = pair === "USD_AUD" ? DAILY_JSON_USD : DAILY_JSON_AUD;
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error("Daily JSON not available: " + path);
      return res.json();
    }
    async function fetchForecast(pair) {
      const path = pair === "USD_AUD" ? FCAST_JSON_USD : FCAST_JSON_AUD;
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error("Forecast JSON not available: " + path);
      return res.json();
    }
    async function fetchSheet15m() {
      if (!SHEET_CSV_URL) throw new Error("SHEET_CSV_URL not set");
      const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Sheet CSV not reachable: " + res.status);
      const rows = parseCSV(await res.text());
      const dataRows = (rows[0] && /date|time/i.test(rows[0][0])) ? rows.slice(1) : rows;
      const candles = [];
      for (const r of dataRows) {
        if (!r || r.length < 2) continue;
        const ts = Date.parse(r[0].replace(" ", "T"));
        const close = parseFloat(r[1]);
        if (!isNaN(ts) && isFinite(close)) {
          candles.push({ ts, open: close, high: close, low: close, close, volume: 0 });
        }
      }
      candles.sort((a,b)=>a.ts-b.ts);
      return { symbol:"AUDUSD (sheet)", interval:"15m", updated: candles.length?candles.at(-1).ts:Date.now(), tz:"UTC",
        meta:{ records:candles.length, first_ts:candles[0]?.ts||null, last_ts:candles.at(-1)?.ts||null,
          session_ohlc:(()=>{ const closes=candles.map(c=>c.close); if(!closes.length) return {open:null,high:null,low:null,close:null}; return {open:closes[0], high:Math.max(...closes), low:Math.min(...closes), close:closes.at(-1)};})(), volume_sum:0 },
        candles };
    }

    const ctx = document.getElementById("chart").getContext("2d");
    let chart;
    function renderChart(labels, data, isUp, forecast) {
      const color = isUp ? "rgb(16,185,129)" : "rgb(220,38,38)";
      const datasets = [{ label:"Close", data, borderColor: color, pointRadius: 1.5, borderWidth: 2.5, tension:.2, fill:false }];
      if (forecast && forecast.yhat && forecast.labels) {
        datasets.push({ label:"Forecast", data: forecast.yhat, borderColor:"rgb(37,99,235)", borderDash:[6,4], pointRadius:0, borderWidth:2 });
        if (forecast.lower && forecast.upper) {
          datasets.push({ label:"Forecast band", data: forecast.upper, borderColor:"transparent", backgroundColor:"rgba(37,99,235,.12)", pointRadius:0, fill:'+1' });
          datasets.push({ label:"Forecast lower", data: forecast.lower, borderColor:"transparent", pointRadius:0 });
        }
      }
      if (chart) chart.destroy();
      chart = new Chart(ctx, { type:"line", data:{ labels, datasets },
        options:{ plugins:{ legend:{ display:false } }, interaction:{ intersect:false, mode:"index" }, scales:{ x:{ ticks:{ maxTicksLimit:12 } }, y:{ beginAtZero:false } } } });
    }

    const sourceNote = document.getElementById("sourceNote");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const heartbeat = document.getElementById("heartbeat");
    const statusMsg = document.getElementById("statusMsg");
    const pairSel = document.getElementById("pair");
    const rangeButtons = $$("button[data-range]");
    let state = { range: "1D" };

    function setActiveRangeButton(range){
      rangeButtons.forEach(btn => {
        const active = btn.dataset.range === range;
        btn.classList.toggle("btn-active", active);
        btn.classList.toggle("btn-inactive", !active);
      });
      document.getElementById("rangeLabel").textContent = range === "1D" ? "session" : range;
      document.getElementById("rangeLabel2").textContent = range === "1D" ? "session" : range;
    }

    function mean(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }
    function stddev(arr){ const m=mean(arr); return Math.sqrt(mean(arr.map(x=>(x-m)**2))); }

    function calcIndicators(dailyCandles){
      if (!dailyCandles || dailyCandles.length < 20) return { ma20:"â€”", vol10:"â€”", slope14:"â€”", atr14:"â€”" };
      const closes = dailyCandles.map(c=>c.close);
      const last = closes.at(-1);
      const ma20 = mean(closes.slice(-20));
      const ret = []; for(let i=1;i<Math.min(11,closes.length);i++){ const r = (closes.at(-i) - closes.at(-(i+1))) / closes.at(-(i+1)); ret.push(r); }
      const vol10 = stddev(ret) * Math.sqrt(252) * 100;
      const y = closes.slice(-14), x = [...Array(y.length).keys()]; const xm=mean(x), ym=mean(y); const slope = x.reduce((s,xi,i)=> s + (xi-xm)*(y[i]-ym), 0) / x.reduce((s,xi)=> s + (xi-xm)**2, 0);
      let trs=[]; for(let i=1;i<Math.min(15,dailyCandles.length);i++){ const h=dailyCandles.at(-i).high, l=dailyCandles.at(-i).low, pc=dailyCandles.at(-(i+1)).close; trs.push(Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc))); }
      const atr14 = mean(trs);
      return { ma20: `${((last-ma20)/ma20*100).toFixed(2)}%`, vol10: `${vol10.toFixed(2)}%`, slope14: `${slope>=0?'+':'âˆ’'}${Math.abs(slope*10000).toFixed(1)} pips/day`, atr14: `${(atr14*10000).toFixed(1)} pips` };
    }

    async function refresh() {
      statusMsg.textContent = "";
      const pair = pairSel.value;
      const range = state.range;
      let payload = null; let source = "";
      const freshnessMinutes = range === "1D" ? 15 : 36 * 60;

      try {
        if (range === "1D") {
          try { payload = await fetchJsonIntraday(pair); source = "Source: Yahoo Finance (15m) via GitHub Actions"; }
          catch(e1){ payload = await fetchSheet15m(); source = "Source: Google Sheets â†’ GOOGLEFINANCE (15m)"; }
        } else {
          payload = await fetchJsonDaily(pair); source = "Source: Yahoo Finance (1d) via GitHub Actions";
          payload.candles = sliceForRange(payload.candles, range);
          const closes = payload.candles.map(c=>c.close);
          if (closes.length) {
            payload.meta.session_ohlc = { open: closes[0], high: Math.max(...closes), low: Math.min(...closes), close: closes.at(-1) };
            payload.meta.first_ts = payload.candles[0].ts; payload.meta.last_ts = payload.candles.at(-1).ts;
          }
        }
      } catch (e) {
        // ECB fallback omitted for brevity in forecast build
        statusMsg.innerHTML = '<span class="note-red">Feed unavailable</span>';
        return;
      }

      const lastTs = payload.meta?.last_ts ?? payload.updated ?? payload.candles.at(-1).ts;
      const minsAgo = Math.floor((Date.now() - lastTs) / 60000);
      const stale = minsAgo > freshnessMinutes;
      lastUpdatedEl.textContent = `Last updated ${new Date(lastTs).toLocaleString([], { hour:'2-digit', minute:'2-digit' })} (${minsAgo}m ago)`;
      heartbeat.classList.toggle("stale", stale);
      sourceNote.textContent = source;

      const ohlc = payload.meta?.session_ohlc || {};
      const first = ohlc.open, last = ohlc.close;
      const delta = (last - first), pct = (delta / first) * 100, isUp = delta >= 0;
      document.getElementById("spot").textContent = Number(last).toFixed(5);
      document.getElementById("asof").textContent = `as of ${new Date(lastTs).toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' })}`;
      document.getElementById("delta").textContent = `${isUp ? 'â–²' : 'â–¼'} ${Math.abs(delta).toFixed(5)}`;
      document.getElementById("pct").textContent = `(${isUp ? '+' : 'âˆ’'}${Math.abs(pct).toFixed(2)}%)`;
      document.getElementById("delta").classList.toggle("text-emerald-600", isUp);
      document.getElementById("delta").classList.toggle("text-red-600", !isUp);
      document.getElementById("pct").classList.toggle("text-emerald-600", isUp);
      document.getElementById("pct").classList.toggle("text-red-600", !isUp);
      document.getElementById("ohlc").textContent = `O ${Number(ohlc.open).toFixed(5)}  H ${Number(ohlc.high).toFixed(5)}  L ${Number(ohlc.low).toFixed(5)}  C ${Number(ohlc.close).toFixed(5)}`;

      // Indicators
      if (state.range !== "1D") {
        const ind = (function(dcs){ 
          if (!dcs || dcs.length<20) return {ma20:"â€”",vol10:"â€”",slope14:"â€”",atr14:"â€”"};
          const closes = dcs.map(c=>c.close); const last = closes.at(-1); const ma20 = mean(closes.slice(-20));
          const ret = []; for(let i=1;i<Math.min(11,closes.length);i++){ const r=(closes.at(-i)-closes.at(-(i+1)))/closes.at(-(i+1)); ret.push(r); }
          const vol10 = stddev(ret)*Math.sqrt(252)*100;
          const y=closes.slice(-14), x=[...Array(y.length).keys()], xm=mean(x), ym=mean(y);
          const slope = x.reduce((s,xi,i)=> s + (xi-xm)*(y[i]-ym), 0) / x.reduce((s,xi)=> s + (xi-xm)**2, 0);
          let trs=[]; for(let i=1;i<Math.min(15,dcs.length);i++){ const h=dcs.at(-i).high, l=dcs.at(-i).low, pc=dcs.at(-(i+1)).close; trs.push(Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc))); }
          const atr14 = mean(trs);
          return { ma20: `${((last-ma20)/ma20*100).toFixed(2)}%`, vol10: `${vol10.toFixed(2)}%`, slope14: `${slope>=0?'+':'âˆ’'}${Math.abs(slope*10000).toFixed(1)} pips/day`, atr14: `${(atr14*10000).toFixed(1)} pips` };
        })(payload.candles);
        document.getElementById("ma20").textContent = ind.ma20;
        document.getElementById("vol10").textContent = ind.vol10;
        document.getElementById("slope14").textContent = ind.slope14;
        document.getElementById("atr14").textContent = ind.atr14;
      } else {
        document.getElementById("ma20").textContent = "â€”";
        document.getElementById("vol10").textContent = "â€”";
        document.getElementById("slope14").textContent = "â€”";
        document.getElementById("atr14").textContent = "â€”";
      }

      const labels = payload.candles.map(c => state.range === "1D"
        ? new Date(c.ts).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })
        : new Date(c.ts).toLocaleDateString([], { month:'short', day:'2-digit' }));
      const closes = payload.candles.map(c => c.close);

      // Forecast overlay (daily only)
      let forecastOverlay = null;
      if (state.range !== "1D") {
        try {
          const fc = await fetchForecast(pair);
          const flabels = fc.points.map(p => new Date(p.ts).toLocaleDateString([], { month:'short', day:'2-digit' }));
          const yhat = fc.points.map(p => p.yhat);
          const lower = fc.points.map(p => p.yhat_lower ?? null);
          const upper = fc.points.map(p => p.yhat_upper ?? null);
          forecastOverlay = { labels: flabels, yhat, lower, upper };
          labels.push(...flabels);
        } catch (e) {}
      }

      renderChart(labels, closes, isUp, forecastOverlay);
      const titlePair = pair === "USD_AUD" ? "USD/AUD" : "AUD/USD";
      document.getElementById("chartTitle").textContent = `${titlePair} â€” ${state.range}${state.range==='1D'?' (15m)':''}`;
    }

    document.getElementById("fullscreenBtn").addEventListener("click", async ()=>{
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    });
    document.getElementById("pair").addEventListener("change", refresh);
    $$("button[data-range]").forEach(btn => btn.addEventListener("click", () => { state.range = btn.dataset.range; setActiveRangeButton(state.range); refresh(); }));

    setActiveRangeButton(state.range);
    refresh();
    setInterval(refresh, 5 * 60 * 1000);
  </script>
</body>
</html>
